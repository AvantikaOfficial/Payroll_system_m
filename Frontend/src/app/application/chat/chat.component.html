<app-nav-bar></app-nav-bar>
<div class="main-wrapper">
  <div class="page-wrapper">
    <div class="content">
      <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 pb-3">
        <div class="flex-grow-1">
          <h5 class="fw-bold mb-0">Chat</h5>
        </div>
        <nav aria-label="breadcrumb"></nav>
      </div>
      <div class="chat-wrapper d-flex">
        <div class="sidebar-group">
          <div id="chats" class="sidebar-content active" data-simplebar>
            <div class="chat-search-header">
              <h5 class="mb-3">Chats</h5>
              <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Search" [(ngModel)]="searchTerm"
                  (input)="filterEmployees()" />
                <span class="input-group-text"><i class="ti ti-search"></i></span>
              </div>
            </div>
            <div *ngFor="let emp of filteredEmployees" class="chat-list mb-2">
              <a href="javascript:void(0);" class="chat-user-list d-flex align-items-center px-3 py-3"
                (click)="selectEmployee(emp)" [class.active]="selectedEmployee?.id === emp.id"
                (mouseenter)="hoveredUser = emp.id" (mouseleave)="hoveredUser = null" [ngStyle]="{
                  'background-color':
                    hoveredUser === emp.id ? '#f5f5f5' : 'transparent',
                  'border-radius': '10px',
                  transition: 'background-color 0.2s ease'
                }" style="text-decoration: none">
                <!-- Avatar -->
                <div class="employee-image-wrapper online me-2">
                  <img [src]="getEmployeeImage(emp)" alt="{{ emp.name }}" class="rounded-circle"
                    style="width: 40px; height: 40px; object-fit: cover" />
                </div>

                <!-- Employee Info -->
                <div class="flex-grow-1 overflow-hidden">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-1 text-truncate" style="font-weight: 500">
                      {{ emp.name }}
                    </h6>

                    <div class="d-flex align-items-center gap-2">
                      <!-- âœ… Unread badge -->
                      <span *ngIf="emp.unreadCount && emp.unreadCount > 0" class="badge bg-danger rounded-pill">
                        {{ emp.unreadCount }}
                      </span>
                      <small class="text-muted">
                        {{
                        emp.lastMessageTime
                        ? (emp.lastMessageTime | date : "shortTime")
                        : ""
                        }}
                      </small>
                    </div>
                  </div>
                  <div class="text-muted small text-truncate" style="max-width: 180px">
                    {{ emp.lastMessage || "" }}
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
        <div class="chat chat-messages show" id="middle">
          <div *ngIf="!selectedEmployee" class="text-center text-muted my-5">
            <p>Select an employee to start chatting.</p>
          </div>
          <!-- RIGHT PANE (chat) -->
          <div *ngIf="selectedEmployee">
            <div class="chat-header d-flex justify-content-between align-items-center">
              <div class="user-details d-flex align-items-center">
                <div class="avatar online me-2">
                  <img [src]="getEmployeeImage(selectedEmployee)" class="rounded-circle"
                    alt="{{ selectedEmployee?.name }}" />
                </div>
                <div class="d-flex flex-column">
                  <div>
                    <h6 class="fw-medium mb-0">{{ selectedEmployee?.name }}</h6>
                  </div>
                  <small class="text-muted animate-typing">
                    is typing<span class="dot"></span><span class="dot"></span><span class="dot"></span>
                  </small>
                </div>
              </div>

              <div class="d-flex align-items-center" *ngIf="selectedEmployee">
                <a href="javascript:void(0)" class="text-muted me-3" (click)="toggleChatSearch()">
                  <i class="ti ti-search"></i>
                </a>

                <div class="custom-dropdown" #dropdownRoot>
                  <button type="button" class="three-dot-btn" (click)="toggleDropdown($event)" aria-haspopup="true"
                    [attr.aria-expanded]="showDropdown">
                    <i class="ti ti-dots-vertical"></i>
                  </button>

                  <div class="dropdown-menu show" *ngIf="showDropdown">
                    <a class="dropdown-item" href="javascript:void(0)" (click)="closeDropdown($event)">
                      <i class="ti ti-bell-off me-2"></i>Mute Notification
                    </a>

                    <a class="dropdown-item" href="javascript:void(0)" (click)="closeDropdown($event)">
                      <i class="ti ti-clock-off me-2"></i>Disappearing Message
                    </a>

                    <a class="dropdown-item" href="javascript:void(0)" (click)="clearMessages(selectedEmployee?.id!)">
                      <i class="ti ti-trash me-2"></i> Clear Messages
                    </a>

                    <a class="dropdown-item" href="javascript:void(0)" (click)="deleteChat(selectedEmployee?.id!)">
                      <i class="ti ti-trash-x me-2"></i>Delete Chat
                    </a>

                    <!-- Block / Unblock -->
                    <a class="dropdown-item" href="javascript:void(0)" *ngIf="!selectedEmployee?.isBlocked"
                      (click)="blockUser(selectedEmployee?.id!)">
                      <i class="ti ti-ban me-2"></i>Block
                    </a>

                    <a class="dropdown-item" href="javascript:void(0)" *ngIf="selectedEmployee?.isBlocked"
                      (click)="unblockUser(selectedEmployee?.id!)">
                      <i class="ti ti-user-check me-2"></i>Unblock
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="showChatSearch" class="input-group my-2">
              <input type="text" class="form-control" placeholder="Search in this chat..."
                [(ngModel)]="chatSearchTerm" />
              <span class="input-group-text"><i class="ti ti-search"></i></span>
            </div>
            <div class="chat-body" #chatContainer id="chat-container" style="
    height: 350px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ccc;
  ">
              <div *ngFor="let msg of filteredMessages" class="mb-3"
                [ngClass]="{ 'text-end': msg.from === currentUserId, 'text-start': msg.from !== currentUserId }">

                <div class="msg-wrapper" [ngClass]="{ 'text-end': msg.from === currentUserId }">

                  <div class="msg-bubble" [ngStyle]="{
            'background-color': msg.from === currentUserId ? '#DCF8C6' : '#EAEAEA'
          }">

                    <!-- Sender -->
                    <small>
                      <b>{{ msg.from === currentUserId ? 'You' : selectedEmployee?.name }}</b>
                    </small>

                    <!-- Deleted message -->
                    <p *ngIf="msg.content === '[deleted]'" class="text-muted fst-italic mb-1">
                      Message deleted
                    </p>

                    <!-- Text -->
                    <p *ngIf="msg.kind === 'text' && msg.content !== '[deleted]'" class="mb-1">
                      {{ msg.content }}
                    </p>

                    <!-- Image -->
                    <img *ngIf="msg.kind === 'image'" [src]="'data:' + msg.mime + ';base64,' + msg.content" alt="Image"
                      style="max-width: 100%; max-height: 300px; border-radius: 8px; margin: 4px 0"
                      [class.sending]="msg.sending" />

                    <!-- Video -->
                    <video *ngIf="msg.kind === 'video'" controls
                      style="max-width: 200px; border-radius: 8px; margin: 4px 0">
                      <source [src]="'data:' + msg.mime + ';base64,' + msg.content" [type]="msg.mime" />
                    </video>

                    <!-- Audio -->
                    <audio *ngIf="msg.kind === 'audio'" controls style="margin: 4px 0; width: 250px"
                      [class.sending]="msg.sending">
                      <source [src]="'data:' + msg.mime + ';base64,' + msg.content" [type]="msg.mime" />
                    </audio>

                    <!-- Time & status -->
                    <div class="d-flex justify-content-between align-items-center mt-1">
                      <small class="text-muted">{{ msg.timestamp | date: 'shortTime' }}</small>
                      <ng-container *ngIf="msg.from === currentUserId && !msg.sending">
                        <i class="ti ti-checks" [ngStyle]="{ color: msg.status === 'seen' ? '#1d9bf0' : '#999' }"
                          style="font-size: 14px"></i>
                      </ng-container>
                      <small *ngIf="msg.sending" class="text-warning">Pending...</small>
                    </div>
                  </div>

                  <!-- 3-dot menu -->
                  <div class="msg-menu" [ngClass]="msg.from === currentUserId ? 'right' : 'left'">
                    <button class="menu-btn" (click)="toggleOptions(msg.id)">
                      <i class="ti ti-dots-vertical"></i>
                    </button>

                    <!-- Options popup -->
                    <div class="options-popup" *ngIf="selectedMessageId === msg.id">
                      <button (click)="replyMessage(msg)"><i class="ti ti-corner-up-left me-1"></i> Reply</button>
                      <button (click)="forwardMessage(msg)"><i class="ti ti-send me-1"></i> Forward</button>
                      <button (click)="copyMessage(msg)"><i class="ti ti-copy me-1"></i> Copy</button>
                      <button (click)="markFavourite(msg)"><i class="ti ti-heart me-1"></i> Favourite</button>
                      <button (click)="deletemessage(msg.id)"><i class="ti ti-trash me-1"></i> Delete</button>
                      <button (click)="markUnread(msg)"><i class="ti ti-mail me-1"></i> Mark as Unread</button>
                    </div>
                  </div>


                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="chat-footer" style="padding: 20px; min-height: 85px">
              <form class="footer-form" (ngSubmit)="sendMessage()" #messageForm="ngForm" autocomplete="off">
                <div class="chat-footer-wrap" style="gap: 15px">
                  <div class="form-item">
                    <a href="#" class="action-circle" (click)="toggleRecording($event)">
                      <i class="ti" [ngClass]="isRecording ? 'ti-square' : 'ti-microphone'"></i>
                    </a>
                  </div>

                  <div class="form-wrap">
                    <input type="text" class="form-control" placeholder="Type Your Message" name="message"
                      [(ngModel)]="newMessage" required autocomplete="off"
                      [disabled]="selectedEmployee?.isBlocked ?? false" />
                  </div>

                  <div class="form-item custom-dropdown" #footerDropdown>
                    <button type="button" class="three-dot-btn" (click)="toggleFooterDropdown($event)">
                      <i class="ti ti-dots-vertical"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-up show" *ngIf="showFooterDropdown">
                      <a class="dropdown-item" href="javascript:void(0)" (click)="openCamera($event)">
                        <i class="ti ti-camera-selfie me-2"></i>Camera
                      </a>
                      <a class="dropdown-item" href="javascript:void(0)" (click)="openGallery($event)">
                        <i class="ti ti-photo-up me-2"></i>Gallery
                      </a>
                      <a class="dropdown-item" href="javascript:void(0)" (click)="openAudioPicker($event)">
                        <i class="ti ti-music me-2"></i>Audio
                      </a>
                    </div>
                  </div>

                  <div class="form-btn">
                    <button class="btn btn-primary" type="submit" [disabled]="
                        newMessage.trim().length === 0 ||
                        selectedEmployee?.isBlocked
                      " title="{{
                        selectedEmployee?.isBlocked
                          ? 'This user is blocked'
                          : 'Send'
                      }}">
                      <i class="ti ti-send"></i>
                    </button>
                  </div>
                </div>
              </form>

              <input #cameraInput type="file" accept="image/*,video/*" capture hidden
                (change)="onPickedMedia($event, 'camera')" />
              <input #galleryInput type="file" accept="image/*,video/*" hidden
                (change)="onPickedMedia($event, 'gallery')" />
              <input #audioInput type="file" accept="audio/*" hidden (change)="onPickedMedia($event, 'audio')" />
            </div>
          </div>

          <!-- Small style for sending state -->
          <style>
            .sending {
              opacity: 0.7;
              position: relative;
            }

            .sending::after {
              content: "Sending...";
              position: absolute;
              right: -70px;
              top: 50%;
              transform: translateY(-50%);
              color: #666;
              font-size: 12px;
            }
          </style>
        </div>
      </div>
    </div>
  </div>
</div>